% Test bench script for 'audiopluginexample.ParametricEqualizerWithUDP'.

% Generated by Audio Test Bench on 6-May-2018 23:13:50 +0100.

% Create test bench input and output

deviceReader = audioDeviceReader('Device','Duet USB', ...
    'BitDepth','24-bit integer', ...
    'ChannelMappingSource','Property');

deviceWriter = audioDeviceWriter('Device','Duet USB', ...
    'SampleRate',deviceReader.SampleRate);

% Set up the system under test
sut = audiopluginexample.ParametricEqualizerWithUDP;
setSampleRate(sut,deviceReader.SampleRate);
tuneParameters(sut);
setupMIDIControls(sut);

% Stream processing loop
nOverruns = 0;
nUnderruns = 0;
maxIterations = 1000;
for iter = 1:maxIterations
   
   % Read from input, process, and write to output
    [in,novr] = deviceReader();
    nOverruns = nOverruns + novr;   % Increment the overrun counter
    out = sut(in);
    nUnderruns = nUnderruns + deviceWriter(out);
   
    % To tune parameters during streaming, uncomment the code below and
    % customize tuneParameters function
    % tuneParameters(sut);
end

% Clean up

release(sut);
release(deviceReader);
release(deviceWriter);
function tuneParameters(sut)

%tuneParameters Tune the parameter values on the system under test

sut.PeakGain1 = -2.32044;
sut.CenterFrequency1 = 6680.97;
sut.QualityFactor1 = 35.5821;
sut.PeakGain2 = 0;
sut.CenterFrequency2 = 1000;
sut.QualityFactor2 = 2;
sut.PeakGain3 = 0;
sut.CenterFrequency3 = 1606.17;
sut.QualityFactor3 = 2;
end

function setupMIDIControls(sut)

%setupMIDIControls Configure MIDI connections on the system under test

configureMIDI(sut,'PeakGain1',1003,'DeviceName','Akai MPK49 Port 1');
configureMIDI(sut,'CenterFrequency1',1009,'DeviceName','Akai MPK49 Port 1');
configureMIDI(sut,'QualityFactor1',1014,'DeviceName','Akai MPK49 Port 1');
configureMIDI(sut,'PeakGain2',1015,'DeviceName','Akai MPK49 Port 1');
configureMIDI(sut,'CenterFrequency2',1019,'DeviceName','Akai MPK49 Port 1');
configureMIDI(sut,'QualityFactor2',1019,'DeviceName','Akai MPK49 Port 1');
configureMIDI(sut,'PeakGain3',1019,'DeviceName','Akai MPK49 Port 1');
configureMIDI(sut,'CenterFrequency3',1014,'DeviceName','Akai MPK49 Port 1');
configureMIDI(sut,'QualityFactor3',1052,'DeviceName','Akai MPK49 Port 1');

end

